<template>
  <NuxtLayout name="dashboard-page">
    <div class="space-y-12">
      <nav class="flex flex-row">
        <NuxtLink :to="`${$route.path}`" class="dark:bg-accent-dark/10 hover:dark:bg-accent-dark/20 w-1/4 py-4 text-center text-lg" :class="{ 'border-accent-mid dark:bg-accent-dark/20 border-b-4': !edit }">
          General
        </NuxtLink>
        <NuxtLink :to="`${$route.path}?edit=details`" class="dark:bg-accent-dark/10 hover:dark:bg-accent-dark/20 w-1/4 py-4 text-center text-lg" :class="{ 'border-accent-mid dark:bg-accent-dark/20 border-b-4': edit === `details` }">
          Details
        </NuxtLink>
        <NuxtLink :to="`${$route.path}?edit=origin`" class="dark:bg-accent-dark/10 hover:dark:bg-accent-dark/20 w-1/4 py-4 text-center text-lg" :class="{ 'border-accent-mid dark:bg-accent-dark/20 border-b-4': edit === `origin` }">
          Origin
        </NuxtLink>
        <NuxtLink :to="`${$route.path}?edit=storage`" class="dark:bg-accent-dark/10 hover:dark:bg-accent-dark/20 w-1/4 py-4 text-center text-lg" :class="{ 'border-accent-mid dark:bg-accent-dark/20 border-b-4': edit === `storage` }">
          Storage
        </NuxtLink>
      </nav>

      <FormSpecimenDetails v-if="edit === `details`" :specimen="specimen!" @save="onSave" @cancel="navigateTo(`/dashboard/specimens`)" />
      <FormSpecimenOrigin v-else-if="edit === `origin`" :specimen="specimen!" @save="onSave" @cancel="navigateTo(`/dashboard/specimens`)" />
      <FormSpecimenStorageHistory v-else-if="edit === `storage`" :specimen="specimen!" @save="onSave" @cancel="navigateTo(`/dashboard/specimens`)" />
      <FormSpecimen v-else :specimen="specimen!" @save="onSave" @cancel="navigateTo(`/dashboard/specimens`)" />
    </div>

    <template #sidebar>
      <EntityAdminSidebar :entities="[specimen!]">
        <SpecimenDetails :specimen="specimen!" />
        <template #actions>
          <div class="space-y-2">
            <button v-if="hasPermission(/^delete:specimen:/)" class="button button-lg button-outline-red-dark hover:button-red-dark w-full" @click.stop.prevent="onClickDelete">
              Delete
            </button>
          </div>
        </template>
      </EntityAdminSidebar>
    </template>
  </NuxtLayout>
</template>

<script setup lang="tsx">
import { type Specimen, Status } from 'types/specimen'

definePageMeta({
  layout: false,
  name: `Edit specimen`,
})

const { slug } = useRoute().params
const edit = ref(useRoute().query.edit)

onUpdated(async () => {
  edit.value = useRoute().query.edit
  const { entity: updatedSpecimen } = await fetchByPK(slug as string)
  if (updatedSpecimen.value) {
    specimen.value = updatedSpecimen.value
  }
})

const { hasPermission } = useCurrentUser()
const { createToast } = useToasts()
const { fetchByPK, remove, update } = useEntityType<Specimen>(`Specimen`)
const { entity: specimen } = await fetchByPK(slug as string)
if (!specimen.value) {
  showError({ statusCode: 404 })
}

const onSave = async (values: Specimen) => {
  const { entity: updatedSpecimen, error } = await update({ self: specimen.value!.self, ...values })
  if (updatedSpecimen.value) {
    createToast(`update-${specimen.value!.id}`, () => `Specimen updated`, { type: `success`, duration: 3000 })
  } else if (error.value) {
    createToast(`error-updated-${specimen.value!.id}`, () => `${error.value}`, { type: `error`, duration: 5000 })
  }
}

const { setContent, close: closeModal } = useModal()
const onClickDelete = () => {
  const label = `the specimen "${specimen.value!.id.toUpperCase()}"`
  setContent(() => <PvEntityDeleteConfirm label={label} onConfirm={onDeleteConfirmed} onCancel={closeModal} />)
}

const onDeleteConfirmed = async () => {
  const { error } = await remove(specimen.value)
  if (!error.value) {
    closeModal()
    createToast(`delete-${specimen.value!.id}`, () => `Deleted specimen ${specimen.value!.id}`, { type: `warning` })
    await navigateTo(`/dashboard/specimens`)
  }
}
</script>
